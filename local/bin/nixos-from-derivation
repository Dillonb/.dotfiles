#!/usr/bin/env bash
derivation=$1
profile=/nix/var/nix/profiles/system
operation="boot"

if [ -z "$2" ]; then
    operation="boot"
else
    operation="$2"
fi

echo "Switch $(hostname) to $derivation"
echo ""
read -r -p "Are you sure? [y/N] " response
case "$response" in
    [yY][eE][sS]|[yY])
        echo "Realizing derivation"
        nix-store --realise "$derivation"
        echo "Updating $profile"
        echo "Adding $derivation"

        sudo nix-env -p $profile --set "$derivation"
        echo "Added to system profile. Switching to it:"
        sudo $derivation/bin/switch-to-configuration $operation
        ;;
    *)
        echo "Exiting."
        ;;
esac
