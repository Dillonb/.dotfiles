#!/usr/bin/env bash
derivation=$1
profile=/nix/var/nix/profiles/system

if [ -z "$2" ]; then
    echo "Usage: $0 <derivation> [switch|boot|build]"
    exit 1
else
    operation="$2"
fi

echo "Update $(hostname) to $derivation: $operation"
echo ""
nvd diff /nix/var/nix/profiles/system "$derivation"
echo ""
read -r -p "Are you sure? [y/N] " response
case "$response" in
    [yY][eE][sS]|[yY])
        nix-store --realise "$derivation" --log-format bar-with-logs
        sudo nix-env -p $profile --set "$derivation"
        sudo "$derivation/bin/switch-to-configuration" "$operation"
        ;;
    *)
        echo "Exiting."
        ;;
esac
